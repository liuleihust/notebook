## VMware 虚拟机三种网络模式

### 桥接

桥接模式是将主机网卡与虚拟机虚拟的网卡利用虚拟网桥（**一种对帧进行转发的技术，根据 MAC 分区块，可隔离碰撞**）进行通信。在桥接的作用下，类似于把物理主机虚拟为一个交换机，所有桥接设置的虚拟机连接到这个交换机的一个接口上，物理主机也同样插在这个交换机当中，所以所有桥接下的网卡与网卡都是交换模式的，相互可以访问而不干扰。在桥接模式下，虚拟机IP 地址需要与主机在同一个网段（这样发往虚拟机的网络包才可以发往物理机网卡）。

### NAT 模式

*Network Address Translation* 网络地址转换 

NAT 将 私有IP 地址通过边界路由转换成外网IP 地址，在边界路由的NAT 地址转换表记录下这个转换映射记录，当外部数据返回时，路由使用NAT  技术查询NAT 转换表，再将目标地址替换成内网用户IP 地址。

三种NAT技术

- 静态NAT 

  一对一映射，内部有多少私有地址需要和外部通信，就要配置多少外网IP 地址与其对应，并不节省外网IP，一般不用。

- 动态NAT

   动态NAT是在路由器上配置一个外网IP地址池，当内部有计算机需要和外部通信时，就从地址池里动态的取出一个外网IP，并将他们的对应关系绑定到NAT表中，通信结束后，这个外网IP才被释放，可供其他内部IP地址转换使用，这个DHCP租约IP有相似之处。

- **PAT(port address Translation，端口地址转换，也叫端口地址复用)**

   最常用的NAT 技术，提供了一种**多对一**的方式，对多个内网ip地址，边界路由可以给他们分配一个外网IP，利用这个**外网IP的不同端口**和外部进行通信。

   对于nat，每一个访问的建立，都会在防火墙上留下记录，比如192.168.1.50的12345端口复用了200.201.30.41的54321端口进行对新浪的访问，则防火墙会有一个对应的表：200.201.30.41:54321<——>192.168.1.50:12345，当数据返回时，仍然会按照这个连接，将数据返回给内网主机192.168.1.50；当连接结束时，会释放200.201.30.41:54321的端口，这时，54321号端口又可以给其他的连接请求使用。这是对于nat的情况。

   ![img](https://pic4.zhimg.com/80/v2-43d2ad2c88919c0d3699cb7d4c6c2f29_hd.jpg)

   NAT模式借助**虚拟NAT设备和虚拟DHCP服务器**，使虚拟机可以联网，比较适用于网络ip资源紧缺的情况。在NAT模式中，主机网卡直接与虚拟NAT设备相连，然后虚拟NAT设备与虚拟DHCP服务器一起连接在虚拟交换机VMnet8上，这样就实现了虚拟机联网。

![wKioL1ivr5PzQxNdAAMSz2NTYXk509.jpg](https://s4.51cto.com/wyfs02/M01/8D/EC/wKioL1ivr5PzQxNdAAMSz2NTYXk509.jpg)





## 虚拟化和云

虚拟化的主要思想是**虚拟机监控程序**（*Virtual Machine Monitor* ）在同一物理硬件上创建出有多台虚拟机器的假象。  VMM又称作 虚拟机管理程序（*hypervisor*）。

虚拟化技术有效的前提是绝大多数服务中断不是硬件缺陷造成的，而是由于软件设计不周、不可靠、有缺陷、配置不当造成的，特别是操作系统。使用虚拟化技术，只有虚拟机管理程序在最高特权级别下运行，而虚拟机管理程序的代码行数比操作系统少两个数量级，因而缺陷数量也少两个数量级。

虚拟机管理程序需要在一下三个维度上有良好的表现：

- **安全性**：虚拟机管理程序应完全掌握虚拟资源

- **保真性**：程序在虚拟机上执行的行为应与在裸机上相同
- **高效性**：虚拟机中运行的大部分代码应不受虚拟机管理程序的干涉

### 保真性

机器可虚拟化的一个必要条件是 敏感指令为特权指令的子集，即 **用户态想要做不应该在用户态做的事情，硬件必须陷入**。

2005 年之前的 x86 处理器上，还存在可以在用户态读取敏感状态而不造成陷入的指令。在虚拟机中，操作系统若这样做并发现自己运行在用户态，就会做出错误的决策。

在2005年之后，CPU 中引入 虚拟化支持，该项技术称作 VT，VT 技术的基本思想是 创建可以运行虚拟机的容器。客户操作系统在容器中启动并持续运行，直到触发异常并陷入虚拟机管理程序，例如试图执行 I/O 指令，会造成陷入的指令集合由虚拟机管理程序设置的硬件位图控制。

有了这些扩展之后，在X86	机器上实现经典的 **陷入并模拟** 虚拟机成为可能。

虚拟机管理程序必须保证自己能够收到对应的陷入，通常，虚拟机管理程序在底层操作系统内核中有一个模块，用于将**陷入转到自己的处理程序**中。

直接运行客户机代码并使用完全相同的技术需要第二类虚拟机管理程序能在最底层操纵硬件，这在用户态无法实现。例如，虚拟机管理程序需要对客户机代码设置正确的段描述符。为了实现准确可靠的虚拟化，还需要让客户操作系统认为自己对机器资源和整个地址空间有完全的掌控。如果让客户操作系统在地址空间里发现了宿主操作系统的踪影，就会发生冲突。

类似的，虚拟机管理程序还需要正确地处理中断，例如磁盘发出的中断或缺页异常。如果虚拟机管理程序要使用陷入并模拟的方式处理中断，同样需要能接收陷入，而用户进程不可能在内核中安装陷入/中断处理程序。

 



**3、限制对虚拟机的访问**    

　　宿主机对虚拟机的攻击有着得天独厚的条件，类似与贴身肉搏这种攻击，包括：

　　A：不需要账户和密码，即可使用操作系统特定的热键来杀死进程，监控资源的使用或者关闭机器。

　　B：重启机器，引导到外部媒体从而破解密码。

　　C: 窃取文件，比如利用软驱、光驱、USB等。

　　D: 捕获进出的网络流量。

　　E: 删除一个或多个磁盘，把它们挂载到已知管理员密码的机器上，可以进入虚拟机，从而看到全部内容。

　　F： 删除整个虚拟机。

　　宿主机的环境不同，造成的风险也不同，所以要对宿主机的安全提供细致的安全措施：

　　A: 宿主机的物理环境安全，包括对进入机房的身份卡验证，对机器进行加锁（避免被人窃走硬盘）。

　　B:在安装完毕后拆除软驱、光驱。

　　C:在BIOS里，禁止从其它设备引导，只允许从主硬盘引导。另外对BIOS设置密码，避免被人修改启动选项。

　　D:控制所有的外部接口。

### 虚拟机安全检测

1. 虚拟机间网络监测

虚拟化的数据中心应用了新的网络模型，将多个操作系统或应用程序部署在同一个物理服务器上的多个虚拟机上，这些虚拟机通过资源调度方式进行服务器硬件资源的共享，同一个平台上的虚拟机之间的网络通信流量可以相互隔离。服务器虚拟化，传统的安全产品和技术暂时不能有效的保护其安全，会对安全造成较大的挑战。

例如，

![1563198553256](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1563198553256.png)

图中 平台的安全保护措施建立在于交换机相连的防火墙和IDS上，VM1 和VM2 之间的通信和虚拟机和磁盘之间的通信没有安全防范措施。一旦某一个虚拟机感染病毒时，其它相邻虚拟机就可以会很快的感染。当系统中的权限管理类虚拟机被感染后，病毒程序都会通过该虚拟机修改系统的核心代码以及关键组件的核心驱动程序或应用程序，导致数据丢失、资源盗用甚至系统 崩溃。

论文中通过对内部网络进行网络流量监控和网络数据包异常分析进行动态网络监测。

### 宿主机对虚拟机的攻击

目前云安全方面研究仍然几种在传统的安全模型上，很少有人去关注来自云内部的安全隐患。内部的安全问题一直被忽视，直到谷歌员工两次被爆出利用管理权限窃取用户在云环境中隐私数据的时候，人们才意识到云内部安全问题不容忽视。

论文从这样的问题入手，以防护来自Xen 内部安全隐患为目标，以隔离为手段，分别从块设备、内存以及桌面协议三方面对Xen云环境中的虚拟机安全隔离进行研究。

- 块设备隔离通过加密 虚拟机中模拟的硬盘数据，使得宿主机的管理员无法通过管理工具查看虚拟硬盘中的数据。
- 内存隔离通过修改Hypervisior 中授权表工作流程，并扩展ACM框架完成内存映射的控制与鉴别，使得管理员无法从 宿主机非法访问用户虚拟机内存。
- 桌面协议隔离 虚拟VGA 图像，防止管理员获取到虚拟机内桌面协议数据。

```java
开启多个线程 // 线程数为 CPU个数*2

每个线程执行
while(循环一定次数){
	进行浮点数计算;
}

输出执行完成的时间
```

