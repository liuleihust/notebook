

# KVM 虚拟化技术实战与原理解析

## 虚拟化与云计算

### 发展历史和现状

20世纪90年代，为了充分利用空闲的CPU资源，通过网络互联搭建平行分布式计算平台，诞生了**网格计算**。在网格计算中，将一个大型的计算任务拆分，分配给各个网格终端计算然后组合的思想，与云计算中的 *Map/Reduce*技术不谋而合。



现在的云计算平台中，Amazon使用弹性计算云（EC2）和简单存储服务（S3）为企业提供计算和存储服务。

### 概念

**定义**：云计算是一种按使用量付费的模式，这种模式提供可用的、便捷的、按需的网络访问，进入可配置的计算资源共享池，这些资源能够被快速提供，只需投入很少的管理工作。

> QEMU提供一系列的硬件模拟设备(CPU，网卡，磁盘等)，客户机指令都需要QEMU翻译，因而性能较差。**KVM是linux内核提供的虚拟化，可以用来进行vCPU的创建与运行，虚拟内存的地址空间分配，指令执行效率较高，但缺少IO设备的虚拟化**。QEMU-KVM就是KVM与QEMU的结合，KVM负责CPU虚拟化+内存虚拟化，QEMU模拟其它IO设备。

### 云计算模式

云计算是推动IT转向**业务为中心**模式的一次重大变革。

1. **软件即服务**

SaaS提供商将应用软件统一部署在自己的服务器上，用户根据需求通过互联网向厂商订购应用软件服务，服务提供商根据客户所定软件的数量、时间的长短等因素收费，并且通过浏览器向客户提供软件的模式。

2.  **平台即服务**

PaaS 把开发环境作为一种服务来提供。这是分布式平台服务，厂商提供开发环境、服务器平台、硬件资源等服务给客户，用户在其平台基础上定制开发自己的应用程序并通过其服务器和互联网传递给其他客户。

开发环境一般包括 **数据库、语言开发环境等。**

3. **基础设施即服务**

IaaS 即把厂商的多台服务器组成的云端基础设施，作为计量服务提供给客户。它将内存、IO设备、存储和计算能力整合成一个虚拟的资源池为整个业界提供所需要的存储资源和虚拟化服务器等服务。

## 云计算技术

云计算改变了现有的以本地计算为主的应用模型。大量的计算任务，由客户端通过网络发起，在云计算提供商的数据中心的服务器集群上进行计算，其结果经由网络返回，在客户端进行呈现。

### Map/Reduce

它是一种简化的分布式编程模型和高效的任务调度模型，用于大规模数据集（大于1TB） 的并行运算。严格的编程模型使云计算环境下的编程十分简单。MapReduce模式的思想是将要执行的问题分解成**Map**(映射)和**Reduce**(化简)的方式。先通过Map 程序将数据切割成不相关的区块，分配给大量计算机处理，达到分布式运算的效果，再通过Reduce 程序将结果汇总输出。

### 资源管理平台

云计算系统的平台管理技术能够使大量的服务器协同工作，方便进行业务部署和开通，快速发现和恢复系统故障，通过自动化、智能化的手段实现大规模系统的可靠运营。

### 虚拟化

虚拟化是构建云基础架构不可或缺的关键技术之一。云计算的云端系统，其实质上就是一个大型分布式系统。虚拟化通过在一个物理平台上虚拟出更多的虚拟平台，而其中的每一个虚拟平台则可以作为独立的终端加入云端的分布式系统。



## 虚拟化技术



### 虚拟化-软件方案

纯软件虚拟化，顾名思义，就是用纯软件的方法在现有的物理平台上，实现对物理平台访问的**截获和模拟**。

- **QEMU** ，它是通过纯软件来**仿真**X86平台处理器的取指、解码和执行，客户机的指令并不在物理平台上直接执行。由于所有的指令都是软件模拟的，因此性能往往比较差，但是可以在同一平台上模拟不同架构平台的虚拟机。
- VMWare 的软件虚拟化则使用了动态二进制翻译的技术。虚拟机监控机在可控制的范围内，允许客户机的指令在物理平台上直接运行。但是，客户机指令在运行前会被虚拟机监控机扫描，其中突破虚拟机监控机限制的指令会被动态替换为可以在物理平台上直接运行的安全指令，或替换为对虚拟机监控器的软件调用。这样做的好处是比纯软件模拟性能有大幅的提升，但是也同时失去了跨平台虚拟化的能力。

### 虚拟化-硬件方案

硬件虚拟化，就是物理平台本身提供了对特殊指令的截获和重定向的硬件支持。甚至，新的硬件会提供额外的资源来帮助软件实现对关键硬件资源的虚拟化，从而提升性能。

支持虚拟技术的X86 CPU 带有特别优化过额度指令集来控制虚拟过程，通过这些指令集，VMM 会很容易将客户机置与一种受限制的模式下运行，一旦客户机试图访问物理资源，硬件会暂停客户机的运行，将控制权交给VMM 处理。**VMM 还可以利用硬件的虚拟化增强机制，将客户机在受限模式下对一些特定资源的访问，完全由硬件重定向到VMM 指定的虚拟资源，整个过程不需要暂停客户机的运行和VMM 软件的参与**。



### 准虚拟化与全虚拟化

1. **准虚拟化**

软件虚拟化可以在缺乏硬件虚拟化支持的平台上完全通过VMM软件来实现对各个虚拟机的监控，以保证它们之间彼此独立和隔离。

准虚拟化通过改动客户操作系统，使它以为自己运行在虚拟环境下，能够与虚拟机监控机协同工作。这种方法就叫准虚拟化，也叫半虚拟化。

**本质上，准虚拟化弱化了对虚拟机特殊指令的被动截获要求，将其转化成客户机操作系统的主动通知。**



**Xen** 是开源准虚拟化技术的一个例子。操作系统作为虚拟服务器在Xen Hypervisor上运行之前，它必须在内核层面进行某些改变。



2. **全虚拟化**

与准虚拟化技术不同，全虚拟化为客户机提供了完整的虚拟X86平台，包括处理器、内存和外设，支持运行 任何理论上可在真实物理平台上运行的操作系统，为虚拟机的配置提供最大程度的灵活性。

## KVM 简介

> Kernel Virtual Machine (内核虚拟机)，通过加载新的模块从而使Linux Kernel  本身变成一个 Hypervisor ，2006 年 KVM 源代码被正式接纳进入了 Linux Kernel 。 

### KVM 功能概览

KVM 是基于虚拟化扩展的（Intel VT 或AMD-V） 的 X86硬件，是Linux 完全原生的全虚拟化支持。

在KVM 架构中，虚拟机实现为从常规的Linux 进程，**由标准Linux 调度程序进行调度**。事实上，**每个虚拟机CPU 显示为一个常规的Linux进程**。这使KVM 能够享受Linux 内核的所有功能。

KVM 本身不执行任何模拟，需要用户空间程序通过 /dev/kvm 接口设置一个客户机虚拟服务器的地址空间，向它提供 模拟的I/O ，并将它的视频显示映射回宿主的显示屏。

#### 内存管理

KVM 从Linux 继承了强大的内存管理功能。一个虚拟机的内存与任何其他Linux 进程的内存一样进程存储，可以以大页面的形式进行交换以实现更高的性能，也可以以磁盘文件的形式进行共享。

内存页面共享通过内核同页合并的内核功能来支持.ksm扫描每个虚拟机的内存，如果虚拟机拥有相同的内存页面，KSM将这些页面合并到一个虚拟机之间共享的页面，仅存储一个副本，如果一个客户机想修改这个共享页面，它将得的自己的专用副本。

#### 存储

KVM 能够使用Linux 支持的任何存储来存储虚拟机镜像。KVM还支持全局文件系统（GFS2）等共享文件系统上的虚拟机镜像，以允许虚拟机在多个宿主之间共享或使用逻辑卷共享。磁盘镜像支持按需分配，仅在虚拟机需要时分配存储空间，而不是提前分配整个存储空间，提高存储利用率。KVM原生磁盘格式为QCOW2，它支持快照，运行压缩和加密。

#### 设备驱动程序

KVM支持混合虚拟化，其中准虚拟化的驱动程序安装在客户机操作系统中，运行虚拟机使用优化的IO接口而不使用模拟的设备，从而为网络和块设备提供高性能的I/O。

### KVM 架构

![1564046892939](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1564046892939.png)

KVM 通过内核模块的形式实现出来就好，其他的部分则尽可能充分利用Linux 内核的既有实现，最大限度地重用代码。

## KVM 模块

KVM 模块是KVM 虚拟机的核心部分。其主要功能是初始化CPU硬件，打开虚拟机模式，然后将虚拟客户机运行在虚拟机模式下，并对虚拟客户机地运行提供一定的支持。

以KVM 在Intel 公司的CPU 上运行为例，在被内核加载的时候，KVM 模块会先初始化内部的数据结构；做好准备后，**KVM**模块会检测系统当前的CPU，然后打开CPU控制寄存器CR4中的虚拟化模式开关，并通过执行VMXON 指令将宿主操作系统置于虚拟化模式的**根模式**；最后，KVM模块创建特殊设备文件 **/dev/kvm** 并等待来自用户空间的命令。接下来虚拟机的创建和运行是一个用户空间的应用程序（qemu）和KVM 模块相互配合的过程。

KVM 模块与用户空间QEMU 的通信接口主要是一系列针对特殊设备文件的IOCTL 调用。IOCTL 调用就是 “**创建虚拟机**”。在这里，创建虚拟机可以理解成KVM 为某个特定的虚拟客户机创建对应的**内核数据结构**。同时，KVM 还会返回一个文件句柄来代表所创建的**虚拟机**。针对该文件句柄的IOCTL 调用可以对虚拟机做相应的管理，比如创建用户空间虚拟地址和客户机物理地址及真实内存物理地址的映射关系，再比如创建多个可供运行的虚拟处理器（vcpu）。KVM 模块会为每个创建出来的虚拟处理器生成对应的文件句柄，对虚拟处理器相应的文件句柄进行相应的**IOCTL** 调用，就可以对虚拟处理器进行管理。

用户空间准备好的虚拟机再KVM 模块的支持下，被置于虚拟化模式中的非根模式下，开始执行二进制指令。**再非根模式下，所有敏感的二进制指令都会被处理器捕捉到，处理器再保存现场之后自动切换到 根模式，由KVM决定如何进一步处理。**

#### 内存虚拟化

虚拟机模式下，处理器中内存管理单元（MMU） 则必须再一次查询的时候完成两次地址转换。这是因为，除了要将客户机程序的虚拟地址转换成为客户机物理地址以外，还必须将客户机物理地址转化成为真实物理地址。KVM 模块开始使用了**影子页表**的技术来解决这个问题：客户机运行时候，处理器真正使用的页表并不是客户机操作系统维护的页表，而是KVM 模块根据这个页表维护的另外一套**影子页表**。

影子页表开销大，新的处理器再硬件上做了增强，硬件可以自动进行两级转换生成正确的内存访问地址。**KVM 模块将其称为二维分页机制**。

处理器对设备的访问主要是通过IO 指令和MMIO ，其中IO 指令会被处理器直接截获，MMIO 会通过配置内存虚拟化来捕捉。一般来说，只有对性能要求较高的虚拟设备才会由KVM内核模块来直接负责，比如虚拟中断控制器和虚拟时钟，这样可以减少处理器的模式切换的开销。



## QEMU设备模型

再虚拟机运行期间，QEMU 会通过KVM 模块提供的系统调用进入内核，由KVM 模块负责虚拟机置于处理器的特殊模式运行。**遇到虚拟机进行输入输出操作，KVM 模块会从上次的系统调用出口返回QEMU** ，由QEMU 来负责解析和模拟这些设备。

从QEMU角度来看，也可以说QEMU使用了KVM模块的虚拟化功能，为自己的虚拟机提供硬件虚拟化的加速，从而极大地提高了虚拟机的性能。除此之外，虚拟机的配置和创建，虚拟机运行依赖的虚拟设备，虚拟机运行时的用户操作环境和交互，以及一些针对虚拟机的特殊技术（例如动态迁移）,都是由QEMU自己实现的。

## Intel 虚拟化技术

大致分为三类：

1. 处理器相关
2. 芯片组相关
3. 输入输出设备相关



# kvm 核心基础功能

要运行一个完整的计算机系统，必不可少的最重要的子系统包括：处理器（CPU）、内存、存储、网络、显示等。

## CPU 配置

### vCPU的概念

在KVM 环境中，每个客户机都是一个标准的Linux 进程，而每一个vCPU 在宿主机中是QEMU进程派生的一个普通线程。

在KVM环境中，进程有三种执行模式：用户模式、内核模式、客户模式。

用户模式：处理IO的模拟和管理，由QEMU的代码实现。

内核模式：处理特别需要高性能和安全相关的指令，如处理客户模式到内核模式的转换，处理客户模式下的IO指令或其他特权指令引起的退出，处理影子内存管理。

客户模式：执行客户机中的大部分指令，IO和一些特权指令除外（它们会引起VM-Exit）

![](C:\Users\Administrator\Documents\笔记\notebook\img\360截图18141217889388.jpg)

### SMP 的支持

SMP ： 对称多处理器

由于每个vCPU 在宿主机中都是一个线程，因此可以通过两种操作来实现客户机的SMP，**一是将不同的vCPU的进程交换执行（分时调度），二是将在物理SMP硬件系统上同时执行多个vCPU的进程**。

### CPU 模型

QEMU/KVM 在默认情况下会向客户机提供一个名为qemu64或qemu32的基本CPU模型。

在X86-64 平台上编译和运行的qemu，在不加 “-cpu” 的参数启动时，采用“qemu64”作为默认的cpu模型。

### 进程的处理器亲和性和vcpu 的绑定

进程的处理器亲和性即CPU的绑定设置，指将进程绑定到特定的一个或多个CPU上去执行，而不允许将进程调度到其他的CPU上。 设置进程的处理器亲和性带来的好处是可以减少进程在多个CPU之间交换运行带来的缓存命中失效，从该进程运行的角度来看，可能带来一定程度上的性能提升。但是破坏了原有系统的各个CPU的负载均衡。 

需要绑定vCPU的实例：

>作为IAAS类型的云计算提供商的A公司，为客户提供一个有两个逻辑CPU计算能力的一个客户机。要求CPU资源独立被占用，不受宿主机中其他客户机的负载水平的影响。
>
>分两个步骤实现：
>
>1. 启动宿主机时隔离出两个逻辑CPU专门供一个客户机使用。在Linux 内核启动的命令行加上 "isolcpus=" 参数，可以实现cpu的隔离，使得在系统启动后普通进程默认不会调度到被隔离的CPU上执行。
>2. 启动一个拥有两个vcpu的客户机并将其vCPU绑定到宿主机中两个CPU上。
>
>

## 内存配置

### EPT 和VPID 简介

EPT 扩展页表，针对MMU的虚拟化扩展。降低了内存虚拟化的难度，提升了内存虚拟化的性能。属于硬件虚拟化技术。

客户机操作系统看来，客户机可用的内存空间也是一个从零地址开始的连续的物理内存空间。之前为了达到这个目的，需要进行地址转换。

Intel 的CPU提供了EPT技术，直接在硬件上支持两次地址转换，从而降低内存虚拟化实现的复杂度。

![](C:\Users\Administrator\Documents\笔记\notebook\img\360截图18750812195222.jpg)

两次地址转换由硬件自动完成。

### 大页

X86 架构的CPU默认使用4KB 大小的内存页面，但是它们也支持较大的内存页。如果在系统中使用 大页，则内存页的数量会减少，从而需要更少的页表，节约了页表所占用的内存数量，并且所需的地址转换也减少了，TLB 缓存失效的次数也减少了，从而提高了内存访问的性能。

在KVM 中，可以将大页的特性应用到客户机中，qemu-KVM提供了*-mempath FILE* 参数选项用于使用 大页。

## 存储配置

QEMU 提供了对多种块存储设备的模拟，包括IDE设备，SCSI 设备、软盘等。

## 图形显示

### SDL 的使用

SDL 是一个用C语言编写的、跨平台、免费和开源的多媒体程序库，它提供了一个简单的接口用于操作硬件平台的图形显示、声音、输入设备等。

在QEMU 模拟器中的图形显示默认就是使用SDL的。

SDL的功能很好用，也比较强大，不过它也有局限性，那就是在创建客户机并以SDL 方式显示时会直接弹出一个窗口，所以SDL方式只能在图形界面中使用。

### VNC 的使用

VNC 是图形化的桌面分享系统，它使用RFB（Remote FrameBuffer） 协议来远程控制另外一台计算机系统。它通过网络控制端的键盘、鼠标的操作传递到远程的受控计算机，而将远程计算机中的图形显示屏幕反向传输回控制端的VNC窗口中。

